itk_module_test()
set(Libraries
    ${IsotropicWavelets-Test_LIBRARIES})

set(IsotropicWaveletsTests
    itkFrequencyImageRegionIteratorWithIndexTest.cxx
    itkWaveletFrequencyFilterBankGeneratorTest.cxx
    itkRieszFrequencyFilterBankGeneratorTest.cxx
    itkFrequencyExpandTest.cxx
    itkFrequencyShrinkTest.cxx
    itkInd2SubTest.cxx
    itkWaveletFrequencyForwardTest.cxx
    itkWaveletFrequencyInverseTest.cxx
    itkMonogenicSignalFrequencyImageFilterTest.cxx
    itkMonogenicPhaseAnalysisSoftThresholdImageFilterTest.cxx
    itkMonogenicPhaseAnalysisEigenValuesImageFilterTest.cxx
    itkVectorInverseFFTImageFilterTest.cxx
    itkRieszWaveletPhaseAnalysisTest.cxx
  )

if(ITKVtkGlue_ENABLED)
  find_package(VTK REQUIRED)
  include_directories(SYSTEM ${VTK_INCLUDE_DIRS})
  list(APPEND Libraries ${VTK_LIBRARIES})
endif()

CreateTestDriver(IsotropicWavelets "${Libraries}" "${IsotropicWaveletsTests}")

#ITK_VISUALIZE_TESTS is passed to source code.
#change it to 1 to visualize images, for dev purposes.
set(ITK_VISUALIZE_TESTS 1)
target_compile_definitions(IsotropicWaveletsTestDriver PRIVATE ITK_VISUALIZE_TESTS=${ITK_VISUALIZE_TESTS})
# NOTE: If ITK_VISUALIZE_TESTS != 0, require Module_ITKVtkGlue = ON
if(ITK_VISUALIZE_TESTS AND NOT ITKVtkGlue_ENABLED)
  message( FATAL_ERROR "ITK_VISUALIZE_TESTS is set, but Module_ITKVtkGlue is not enabled. Set Module_ITKVtkGlue = ON or set ITK_VISUALIZE_TESTS to 0 to avoid this error." )
endif()

# Wavelet Generator
itk_add_test(NAME itkWaveletFrequencyFilterBankGeneratorTest1
  COMMAND IsotropicWaveletsTestDriver
    itkWaveletFrequencyFilterBankGeneratorTest DATA{Input/collagen_64x64x16.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyFilterBankGeneratorTest1.tiff
    1)
itk_add_test(NAME itkWaveletFrequencyFilterBankGeneratorTest2
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyFilterBankGeneratorTest DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyFilterBankGeneratorTest2.tiff
  2)
# 2D:
itk_add_test(NAME itkWaveletFrequencyFilterBankGeneratorTest2D1
  COMMAND IsotropicWaveletsTestDriver
    itkWaveletFrequencyFilterBankGeneratorTest DATA{Input/checkershadow_gray_540x420.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyFilterBankGeneratorTest2D1.tiff
    1)
  itk_add_test(NAME itkWaveletFrequencyFilterBankGeneratorTest2D2
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyFilterBankGeneratorTest DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyFilterBankGeneratorTest2D2.tiff
  2)
## Riesz Related
# RieszGenerator
itk_add_test(NAME itkRieszFrequencyFilterBankGeneratorTest
  COMMAND IsotropicWaveletsTestDriver
  itkRieszFrequencyFilterBankGeneratorTest DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszFrequencyFilterBankGeneratorTest.tiff
  )
# Monogenic Analysis
itk_add_test(NAME itkMonogenicSignalFrequencyImageFilterTest
  COMMAND IsotropicWaveletsTestDriver
  itkMonogenicSignalFrequencyImageFilterTest DATA{Input/collagen_32x32x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkMonogenicSignalFrequencyImageFilterTest.tiff
  )

itk_add_test(NAME itkMonogenicPhaseAnalysisSoftThresholdImageFilterTest
  COMMAND IsotropicWaveletsTestDriver
  itkMonogenicPhaseAnalysisSoftThresholdImageFilterTest DATA{Input/collagen_32x32x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkMonogenicPhaseAnalysisSoftThresholdImageFilterTest.tiff
  )
#EigenValues
itk_add_test(NAME itkMonogenicPhaseAnalysisEigenValuesImageFilterTest
  COMMAND IsotropicWaveletsTestDriver
  itkMonogenicPhaseAnalysisEigenValuesImageFilterTest DATA{Input/collagen_32x32x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkMonogenicPhaseAnalysisEigenValuesImageFilterTest.tiff
  )

itk_add_test(NAME itkMonogenicPhaseAnalysisEigenValuesImageFilterTest2D
  COMMAND IsotropicWaveletsTestDriver
  itkMonogenicPhaseAnalysisEigenValuesImageFilterTest DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkMonogenicPhaseAnalysisEigenValuesImageFilterTest2D.tiff
  2
  )
# VectorInverseFFT
itk_add_test(NAME itkVectorInverseFFTImageFilterTest
  COMMAND IsotropicWaveletsTestDriver
  itkVectorInverseFFTImageFilterTest DATA{Input/collagen_32x32x16.tiff}
  )
#Wavelet Forward
itk_add_test(NAME itkWaveletFrequencyForwardTest
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyForwardTest DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyForwardTest.tiff
  1 1 )

itk_add_test(NAME itkWaveletFrequencyForwardTest2D
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyForwardTest DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyForwardTest2D.tiff
  1 1 2)

#Wavelet Inverse
itk_add_test(NAME itkWaveletFrequencyInverseTest
  COMMAND IsotropicWaveletsTestDriver
    --compare DATA{Input/collagen_64x64x16.tiff}
              ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest.tiff
    #TODO, justify following tolerance, beyond the unsigned to float conversion.
    # There is a lost of information because FrequencyShrinker, which does not interpolate. But not enough.
    --compareIntensityTolerance 50
  itkWaveletFrequencyInverseTest
  DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest.tiff
  1 1
  )

itk_add_test(NAME itkWaveletFrequencyInverseTestMultiLevel
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyInverseTest
  DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest2.tiff
  2 1
  )
#2D
itk_add_test(NAME itkWaveletFrequencyInverseTest2D
  COMMAND IsotropicWaveletsTestDriver
    --compare DATA{Input/checkershadow_gray_540x420.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest2D.tiff
    #TODO, justify following tolerance, beyond the unsigned to float conversion.
    # There is a lost of information because FrequencyShrinker, which does not interpolate. But not enough.
    --compareIntensityTolerance 50
  itkWaveletFrequencyInverseTest
  DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest2D.tiff
  1 1 2)

itk_add_test(NAME itkWaveletFrequencyInverseTes2DtMultiLevel
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyInverseTest
  DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest2DMultiLevel.tiff
  2 1 2)

itk_add_test(NAME itkWaveletFrequencyInverseTest2DMultiLevelMultiBand
  COMMAND IsotropicWaveletsTestDriver
  itkWaveletFrequencyInverseTest
  DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkWaveletFrequencyInverseTest2DMultiLevelMultiBand.tiff
  2 5 2)
# RieszWavelet Phase Analysis
itk_add_test(NAME itkRieszWaveletPhaseAnalysisTest
  COMMAND IsotropicWaveletsTestDriver
  itkRieszWaveletPhaseAnalysisTest DATA{Input/collagen_32x32x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTest.tiff
  1 1 )

itk_add_test(NAME itkRieszWaveletPhaseAnalysisTestMultiBand
  COMMAND IsotropicWaveletsTestDriver
  itkRieszWaveletPhaseAnalysisTest DATA{Input/collagen_32x32x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTestMultiBand.tiff
  1 5 )

itk_add_test(NAME itkRieszWaveletPhaseAnalysisTestMultiLevel
  COMMAND IsotropicWaveletsTestDriver
  itkRieszWaveletPhaseAnalysisTest DATA{Input/collagen_64x64x16.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTestMultiLevel.tiff
  2 1 )
# itk_add_test(NAME itkRieszWaveletPhaseAnalysisTestMultiLevelMultiBand
#   COMMAND IsotropicWaveletsTestDriver
#   itkRieszWaveletPhaseAnalysisTest DATA{Input/collagen_64x64x16.tiff}
#   ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTestMultiLevelMultiBand.tiff
#   2 5 )
###
itk_add_test(NAME itkRieszWaveletPhaseAnalysisTest2D
  COMMAND IsotropicWaveletsTestDriver
  itkRieszWaveletPhaseAnalysisTest DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTest2D.tiff
  1 1 2 )
itk_add_test(NAME itkRieszWaveletPhaseAnalysisTest2DMultiLevelMultiBand
  COMMAND IsotropicWaveletsTestDriver
  itkRieszWaveletPhaseAnalysisTest DATA{Input/checkershadow_gray_540x420.tiff}
  ${ITK_TEST_OUTPUT_DIR}/itkRieszWaveletPhaseAnalysisTest2DMultiLevelMultiBand.tiff
  2 2 2 )
# FrequencyIterator
itk_add_test(NAME itkFrequencyImageRegionIteratorWithIndexTest
  COMMAND IsotropicWaveletsTestDriver itkFrequencyImageRegionIteratorWithIndexTest)
##Ind2Sub
itk_add_test(NAME itkInd2SubTest
  COMMAND IsotropicWaveletsTestDriver itkInd2SubTest)
### FrequencyExpand and FrequencyShrink
## Even input
#Expand
itk_add_test(NAME itkFrequencyExpandEvenTest
  COMMAND IsotropicWaveletsTestDriver
  --compare
    DATA{Baseline/itkFrequencyExpandEvenTest.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkFrequencyExpandEvenTest.tiff
  itkFrequencyExpandTest
     DATA{Input/collagen_32x32x16.tiff}
     ${ITK_TEST_OUTPUT_DIR}/itkFrequencyExpandEvenTest.tiff
     )
##Shrink
itk_add_test(NAME itkFrequencyShrinkEvenTest
  COMMAND IsotropicWaveletsTestDriver
  --compare
    DATA{Baseline/itkFrequencyShrinkEvenTest.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkFrequencyShrinkEvenTest.tiff
  itkFrequencyShrinkTest
    DATA{Input/collagen_32x32x16.tiff}
    ${ITK_TEST_OUTPUT_DIR}/itkFrequencyShrinkEvenTest.tiff
    )

## Odd input
# Require ITK_USE_FFTWF
# TODO bug in VNL FFT Forward? error with input [21,21,9] about wrong size not being multiple of 2,3,5
if(ITK_USE_FFTWF)
  #Expand
  itk_add_test(NAME itkFrequencyExpandOddTest
    COMMAND IsotropicWaveletsTestDriver
    --compare
      DATA{Baseline/itkFrequencyExpandOddTest.tiff}
      ${ITK_TEST_OUTPUT_DIR}/itkFrequencyExpandOddTest.tiff
    itkFrequencyExpandTest
      DATA{Input/collagen_21x21x9.tiff}
      ${ITK_TEST_OUTPUT_DIR}/itkFrequencyExpandOddTest.tiff
      )
  #Shrink
  itk_add_test(NAME itkFrequencyShrinkOddTest
    COMMAND IsotropicWaveletsTestDriver
    --compare
      DATA{Baseline/itkFrequencyShrinkOddTest.tiff}
      ${ITK_TEST_OUTPUT_DIR}/itkFrequencyShrinkOddTest.tiff
    itkFrequencyShrinkTest
      DATA{Input/collagen_21x21x9.tiff}
      ${ITK_TEST_OUTPUT_DIR}/itkFrequencyShrinkOddTest.tiff
      )
    list(APPEND TEST_LIST
      itkFrequencyExpandOddTest itkFrequencyShrinkOddTest)
endif()

